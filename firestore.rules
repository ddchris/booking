rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isAdmin() {
      // Revert to dynamic database variable to ensure compatibility across environments
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // TimeSlot Validation Logic (Must match utils/timeSlots.ts)
    // Input: timestamp (time) or number
    // We treat timeSlot as a number (millis). 
    // Firestore timestamp to millis: timestamp.toMillis()
    // But here input is number.
    function isValidTimeSlot(ts) {
      // Input 'ts' is UTC millis of the slot (which is constructed from Local TPE time)
      // Example: 13:30 TPE = 05:30 UTC.
      // We want to validate against TPE hours (10-20).
      // So we must shift UTC to TPE (+8 hours = +28800000 ms).
      
      let tpeTs = ts + 28800000;
      // CORRECT WAY to convert millis to keys in Rules:
      let t = timestamp.date(1970, 1, 1) + duration.value(tpeTs, 'ms');
      
      // Minute must be 30
      let validMinute = t.minutes() == 30;
      
      // Hour between 10 and 20 (inclusive) in TPE
      let h = t.hours();
      let validHour = h >= 10 && h <= 20;
      
      // Exclude 12 and 18 (Lunch/Dinner break)
      let notBreak = h != 12 && h != 18;

      return validMinute && validHour && notBreak;
    }

    // 47. --- Collections ---

    // 1. users Collection
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      
      // Allow creation of own profile (First login)
      allow create: if isOwner(uid) || isAdmin();
      
      allow update: if isOwner(uid) || isAdmin();
    }

    // 2. bookings Collection (Private)
    match /bookings/{bookingId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      
      // Allow Admin to Write (Create/Update/Delete) without strict checks
      allow write: if isAdmin();

      // Create (Booking) - User Strict Rules
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == 'booked'
        && isValidTimeSlot(request.resource.data.timeSlot)
        
        // Consistency: public_slots MUST exist after this batch (use getAfter for transactional create)
        && getAfter(/databases/$(database)/documents/public_slots/$(string(request.resource.data.timeSlot))).data != null
        
        // Single Active Booking: User pointer MUST point to this slot
        && getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.activeBookingTimeSlot == request.resource.data.timeSlot;

      // Update (Cancel) - User Strict Rules
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.status == 'cancelled'
        && resource.data.status == 'booked' // Previous status
        
        // Consistency: public_slots MUST NOT exist after this batch
        && !exists(/databases/$(database)/documents/public_slots/$(string(resource.data.timeSlot)))
        
        // Pointer: User pointer MUST be null
        && getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.activeBookingTimeSlot == null;
    }

    // 3. public_slots Collection (Public status, strict existence)
    match /public_slots/{slotId} {
      // Anyone can read existence
      allow read: if true;

      allow create: if isAuthenticated() || isAdmin(); 
      allow update: if isAuthenticated() || isAdmin(); // Handle potential overwrites or locks
      
      allow delete: if isAuthenticated() || isAdmin(); 
    }
  }
}
